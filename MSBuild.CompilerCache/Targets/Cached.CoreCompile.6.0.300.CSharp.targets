<?xml version="1.0" encoding="utf-8"?>
<Project
  DefaultTargets="Build" >
  <Target
    Name="CoreCompile"
    Inputs="$(MSBuildAllProjects);
                  @(Compile);
                  @(_CoreCompileResourceInputs);
                  $(ApplicationIcon);
                  $(KeyOriginatorFile);
                  @(ReferencePathWithRefAssemblies);
                  @(CompiledLicenseFile);
                  @(LinkResource);
                  @(EmbeddedDocumentation);
                  $(Win32Resource);
                  $(Win32Manifest);
                  @(CustomAdditionalCompileInputs);
                  $(ResolvedCodeAnalysisRuleSet);
                  @(AdditionalFiles);
                  @(EmbeddedFiles);
                  @(EditorConfigFiles)"
    Outputs="@(DocFileItem);
                   @(IntermediateAssembly);
                   @(IntermediateRefAssembly);
                   @(_DebugSymbolsIntermediatePath);
                   $(NonExistentFile);
                   @(CustomAdditionalCompileOutputs)"
    Returns="@(CscCommandLineArgs)"
    DependsOnTargets="$(CoreCompileDependsOn);_BeforeVBCSCoreCompile" >
    <!-- These two compiler warnings are raised when a reference is bound to a different version
             than specified in the assembly reference version number.  MSBuild raises the same warning in this case,
             so the compiler warning would be redundant. -->
    <PropertyGroup
      Condition="('$(TargetFrameworkVersion)' != 'v1.0') and ('$(TargetFrameworkVersion)' != 'v1.1')">
      <NoWarn>$(NoWarn);1701;1702</NoWarn>
    </PropertyGroup>
    <PropertyGroup>
      <!-- To match historical behavior, when inside VS11+ disable the warning from csc.exe indicating that no sources were passed in-->
      <NoWarn
        Condition="'$(BuildingInsideVisualStudio)' == 'true' AND '$(VisualStudioVersion)' != '' AND '$(VisualStudioVersion)' &gt; '10.0'">$(NoWarn);2008</NoWarn>
    </PropertyGroup>
    <PropertyGroup>
      <!-- If the user has specified AppConfigForCompiler, we'll use it. If they have not, but they set UseAppConfigForCompiler,
                 then we'll use AppConfig -->
      <AppConfigForCompiler
        Condition="'$(AppConfigForCompiler)' == '' AND '$(UseAppConfigForCompiler)' == 'true'">$(AppConfig)</AppConfigForCompiler>
      <!-- If we are targeting winmdobj we want to specifically the pdbFile property since we do not want it to collide with the output of winmdexp-->
      <PdbFile
        Condition="'$(PdbFile)' == '' AND '$(OutputType)' == 'winmdobj' AND '$(_DebugSymbolsProduced)' == 'true'">$(IntermediateOutputPath)$(TargetName).compile.pdb</PdbFile>
    </PropertyGroup>
    <!-- Condition is to filter out the _CoreCompileResourceInputs so that it doesn't pass in culture resources to the compiler -->
    <!--START OF CACHING EXTENSION CODE-->
    <PropertyGroup>
      <CanCache
        Condition="('$(OutputType)' == 'Library' OR '$(OutputType)' == 'Exe')
AND
'$(AdditionalLibPaths)' == ''
AND
'@(AddModules)' == ''
AND
'$(EmitCompilerGeneratedFiles)' != 'true'
AND
'$(ProvideCommandLineArgs)' != 'true'
AND
'$(ReportAnalyzer)' != 'true'
AND
'$(SkipCompilerExecution)' != 'true'
AND
'$(SourceLink)' == ''
AND
'$(PublicSign)' != 'true'
AND
'@(AdditionalFiles)' == ''
AND
'@(EditorConfigFiles)' == ''
AND
'@(Analyzer)' == ''
AND
'$(DelaySign)' == ''
AND
'$(ErrorLog)' == ''
AND
'$(CompilerGeneratedFilesOutputPath)' == ''
AND
'@(LinkResource)' == ''
AND
'$(ModuleAssemblyName)' == ''
AND
'$(CompilerResponseFile)' == ''
AND
'$(SharedCompilationId)' == ''
AND
'$(CscToolExe)' == ''
AND
'$(CscToolPath)' == ''
AND
'$(VsSessionGuid)' == ''
AND
'$(PathMap)' == ''">true</CanCache>
    </PropertyGroup>
    <PropertyGroup
      Condition="'$(CanCache)' == 'true'">
      <PropertyInputs>AllowUnsafeBlocks=$(AllowUnsafeBlocks);BaseAddress=$(BaseAddress);CheckForOverflowUnderflow=$(CheckForOverflowUnderflow);ChecksumAlgorithm=$(ChecksumAlgorithm);CodeAnalysisRuleSet=$(ResolvedCodeAnalysisRuleSet);CodePage=$(CodePage);DebugType=$(DebugType);DefineConstants=$(DefineConstants);DisabledWarnings=$(NoWarn);DisableSdkPath=$(DisableSdkPath);DocumentationFile=@(DocFileItem);EmbedAllSources=$(EmbedAllSources);EmitDebugInformation=$(DebugSymbols);EnvironmentVariables=$(CscEnvironment);ErrorEndLocation=$(ErrorEndLocation);ErrorReport=$(ErrorReport);Features=$(Features);FileAlignment=$(FileAlignment);GenerateFullPaths=$(GenerateFullPaths);HighEntropyVA=$(HighEntropyVA);Instrument=$(Instrument);KeyContainer=$(KeyContainerName);LangVersion=$(LangVersion);MainEntryPoint=$(StartupObject);NoConfig=true;NoLogo=$(NoLogo);NoStandardLib=$(NoCompilerStandardLib);NoWin32Manifest=$(NoWin32Manifest);Nullable=$(Nullable);Optimize=$(Optimize);Deterministic=$(Deterministic);PublicSign=$(PublicSign);OutputAssembly=@(IntermediateAssembly);OutputRefAssembly=@(IntermediateRefAssembly);PdbFile=$(PdbFile);Platform=$(PlatformTarget);Prefer32Bit=$(Prefer32Bit);PreferredUILang=$(PreferredUILang);ProvideCommandLineArgs=$(ProvideCommandLineArgs);RefOnly=$(ProduceOnlyReferenceAssembly);ReportAnalyzer=$(ReportAnalyzer);RuntimeMetadataVersion=$(RuntimeMetadataVersion);SkipAnalyzers=$(_SkipAnalyzers);SkipCompilerExecution=$(SkipCompilerExecution);SubsystemVersion=$(SubsystemVersion);TargetType=$(OutputType);TreatWarningsAsErrors=$(TreatWarningsAsErrors);UseHostCompilerIfAvailable=$(UseHostCompilerIfAvailable);UseSharedCompilation=$(UseSharedCompilation);Utf8Output=$(Utf8Output);WarningLevel=$(WarningLevel);WarningsAsErrors=$(WarningsAsErrors);WarningsNotAsErrors=$(WarningsNotAsErrors);SourceLink=$(SourceLink)</PropertyInputs>
    </PropertyGroup>
    <ItemGroup
      Condition="'$(CanCache)' == 'true'">
      <FileInputs
        Include="$(AppConfigForCompiler)" />
      <FileInputs
        Include="@(EmbeddedFiles)" />
      <FileInputs
        Include="$(KeyOriginatorFile)" />
      <FileInputs
        Include="@(_CoreCompileResourceInputs);@(CompiledLicenseFile)" />
      <FileInputs
        Include="@(Compile)" />
      <FileInputs
        Include="$(ApplicationIcon)" />
      <FileInputs
        Include="$(Win32Manifest)" />
      <FileInputs
        Include="$(Win32Resource)" />
    </ItemGroup>
    <LocateCompilationCacheEntry
      Condition="'$(CanCache)' == 'true'"
      FileInputs="@(FileInputs)"
      PropertyInputs="@(PropertyInputs)"
      References="@(ReferencePathWithRefAssemblies)"
      BaseCacheDir="$(CompilationCacheBaseDir)">
      <Output
        TaskParameter="CacheDir"
        PropertyName="CacheDir" />
      <Output
        TaskParameter="CacheHit"
        PropertyName="CacheHit" />
    </LocateCompilationCacheEntry>
    <PropertyGroup>
      <DoInvokeCompilation
        Condition="'$(CacheHit)' != 'true' OR '$(CompileAndCheckAgainstCache)' == 'true'">true</DoInvokeCompilation>
    </PropertyGroup>
    <!--END OF CACHING EXTENSION CODE-->
    <Csc
      Condition="'$(DoInvokeCompilation)' == 'true' AND '%(_CoreCompileResourceInputs.WithCulture)' != 'true'"
      AdditionalLibPaths="$(AdditionalLibPaths)"
      AddModules="@(AddModules)"
      AdditionalFiles="@(AdditionalFiles)"
      AllowUnsafeBlocks="$(AllowUnsafeBlocks)"
      AnalyzerConfigFiles="@(EditorConfigFiles)"
      Analyzers="@(Analyzer)"
      ApplicationConfiguration="$(AppConfigForCompiler)"
      BaseAddress="$(BaseAddress)"
      CheckForOverflowUnderflow="$(CheckForOverflowUnderflow)"
      ChecksumAlgorithm="$(ChecksumAlgorithm)"
      CodeAnalysisRuleSet="$(ResolvedCodeAnalysisRuleSet)"
      CodePage="$(CodePage)"
      DebugType="$(DebugType)"
      DefineConstants="$(DefineConstants)"
      DelaySign="$(DelaySign)"
      DisabledWarnings="$(NoWarn)"
      DisableSdkPath="$(DisableSdkPath)"
      DocumentationFile="@(DocFileItem)"
      EmbedAllSources="$(EmbedAllSources)"
      EmbeddedFiles="@(EmbeddedFiles)"
      EmitDebugInformation="$(DebugSymbols)"
      EnvironmentVariables="$(CscEnvironment)"
      ErrorEndLocation="$(ErrorEndLocation)"
      ErrorLog="$(ErrorLog)"
      ErrorReport="$(ErrorReport)"
      Features="$(Features)"
      FileAlignment="$(FileAlignment)"
      GeneratedFilesOutputPath="$(CompilerGeneratedFilesOutputPath)"
      GenerateFullPaths="$(GenerateFullPaths)"
      HighEntropyVA="$(HighEntropyVA)"
      Instrument="$(Instrument)"
      KeyContainer="$(KeyContainerName)"
      KeyFile="$(KeyOriginatorFile)"
      LangVersion="$(LangVersion)"
      LinkResources="@(LinkResource)"
      MainEntryPoint="$(StartupObject)"
      ModuleAssemblyName="$(ModuleAssemblyName)"
      NoConfig="true"
      NoLogo="$(NoLogo)"
      NoStandardLib="$(NoCompilerStandardLib)"
      NoWin32Manifest="$(NoWin32Manifest)"
      Nullable="$(Nullable)"
      Optimize="$(Optimize)"
      Deterministic="$(Deterministic)"
      PublicSign="$(PublicSign)"
      OutputAssembly="@(IntermediateAssembly)"
      OutputRefAssembly="@(IntermediateRefAssembly)"
      PdbFile="$(PdbFile)"
      Platform="$(PlatformTarget)"
      Prefer32Bit="$(Prefer32Bit)"
      PreferredUILang="$(PreferredUILang)"
      ProvideCommandLineArgs="$(ProvideCommandLineArgs)"
      References="@(ReferencePathWithRefAssemblies)"
      RefOnly="$(ProduceOnlyReferenceAssembly)"
      ReportAnalyzer="$(ReportAnalyzer)"
      Resources="@(_CoreCompileResourceInputs);@(CompiledLicenseFile)"
      ResponseFiles="$(CompilerResponseFile)"
      RuntimeMetadataVersion="$(RuntimeMetadataVersion)"
      SharedCompilationId="$(SharedCompilationId)"
      SkipAnalyzers="$(_SkipAnalyzers)"
      SkipCompilerExecution="$(SkipCompilerExecution)"
      Sources="@(Compile)"
      SubsystemVersion="$(SubsystemVersion)"
      TargetType="$(OutputType)"
      ToolExe="$(CscToolExe)"
      ToolPath="$(CscToolPath)"
      TreatWarningsAsErrors="$(TreatWarningsAsErrors)"
      UseHostCompilerIfAvailable="$(UseHostCompilerIfAvailable)"
      UseSharedCompilation="$(UseSharedCompilation)"
      Utf8Output="$(Utf8Output)"
      VsSessionGuid="$(VsSessionGuid)"
      WarningLevel="$(WarningLevel)"
      WarningsAsErrors="$(WarningsAsErrors)"
      WarningsNotAsErrors="$(WarningsNotAsErrors)"
      Win32Icon="$(ApplicationIcon)"
      Win32Manifest="$(Win32Manifest)"
      Win32Resource="$(Win32Resource)"
      PathMap="$(MSBuildProjectDirectory)=/__nonexistent__directory__"
      SourceLink="$(SourceLink)">
      <Output
        TaskParameter="CommandLineArgs"
        ItemName="CscCommandLineArgs" />
    </Csc>
    <!--START OF CACHING EXTENSION CODE-->
    <ItemGroup
      Condition="'$(CanCache)' == 'true'">
      <CompileOutputsToCache
        Include="@(DocFileItem)" />
      <CompileOutputsToCache
        Include="@(IntermediateAssembly)" />
      <CompileOutputsToCache
        Include="@(IntermediateRefAssembly)" />
      <CompileOutputsToCache
        Include="$(PdbFile)" />
    </ItemGroup>
    <UseOrPopulateCache
      Condition="'$(CanCache)' == 'true'"
      IntermediateOutputPath="$(IntermediateOutputPath)"
      OutputsToCache="@(CompileOutputsToCache)"
      CheckCompileOutputAgainstCache="$(CompileAndCheckAgainstCache)"
      CacheHit="$(CacheHit)"
      CacheDir="$(CacheDir)" />
    <!--END OF CACHING EXTENSION CODE-->
    <ItemGroup>
      <_CoreCompileResourceInputs
        Remove="@(_CoreCompileResourceInputs)" />
    </ItemGroup>
    <CallTarget
      Targets="$(TargetsTriggeredByCompilation)"
      Condition="'$(TargetsTriggeredByCompilation)' != ''" />
  </Target>
</Project>